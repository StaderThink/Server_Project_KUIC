@inject AuthenticationStateProvider autentificacion
@inject NavigationManager navegador
@inject ILocalStorageService localStorage
@inject IToastService toaster

@page "/iniciar_sesion"
@layout BaseLayout

@using Aplicacion.Sesiones.Formularios

<h1 class="title is-1">Inicio de sesión</h1>

<hr />

@if (TiempoRestante.Minutes == 0 && Intentos <= 3)
{
    <EditForm Model="Modelo" OnValidSubmit="Enviar">
        <DataAnnotationsValidator />

        <FormField Label="Documento">
            <NumberField @bind-Value="Modelo.Documento" />
            <FormFeedback For="() => Modelo.Documento" Help="Número de documento de identidad (CC o NIT)" />
        </FormField>

        <FormField Label="Contraseña">
            <PasswordField @bind-Value="Modelo.Clave" />
            <FormFeedback For="() => Modelo.Clave" />
        </FormField>

        <FormField>
            <p>¿Olvidaste tu contraseña? Puedes <a href="/reestablecer">reestablecerla ahora</a>.</p>
        </FormField>

        <FormField IsLoading="Cargando">
            <SubmitButton>Ingresar</SubmitButton>
        </FormField>
    </EditForm>
}

else
{
    <h4 class="title is-4">Lamentamos ponerte a esperar.</h4>
    <p>Tu sesión ha sido cancelada por seguridad, por favor espera @(TiempoRestante.Minutes) minuto(s) para volver a ingresar tus credenciales.</p>
}

@code {
    private FormularioIniciarSesion Modelo = new FormularioIniciarSesion();

    private bool Cargando = false;
    private int Intentos = 0;
    private TimeSpan TiempoRestante;

    protected override async Task OnInitializedAsync()
    {
        await ValidarIntentos();
    }

    private async Task ValidarIntentos()
    {
        Cargando = true;

        bool hayTiempoEspera = await localStorage.ContainKeyAsync("login_wait");

        if (hayTiempoEspera)
        {
            try
            {
                var tiempoEspera = await localStorage.GetItemAsync<DateTime>("login_wait");
                var tiempoRestante = tiempoEspera - DateTime.Now;

                if (tiempoRestante.Minutes <= 0)
                {
                    await localStorage.ClearAsync();
                }

                else
                {
                    TiempoRestante = tiempoRestante;
                    Intentos = await localStorage.GetItemAsync<int>("login_tries");
                }
            }

            catch
            {
                toaster.ShowWarning("Hubo un fallo recuperando tu sesión, por favor recarga la página");

                await localStorage.SetItemAsync("login_tries", 4);
                await localStorage.SetItemAsync("login_wait", DateTime.Now.AddMinutes(2));
            }
        }

        Cargando = false;
    }

    private async Task Enviar()
    {
        Cargando = true;

        try
        {
            var nuevoProveedor = (ProveedorAutenticacion) autentificacion;
            await nuevoProveedor.SignIn(Modelo.Documento, Modelo.Clave);

            navegador.NavigateTo("/");
        }

        catch
        {
            Intentos++;

            if (Intentos > 3)
            {
                toaster.ShowError("Has superado el número de intentos permitidos, espera 5 minutos para volver a intentar.");

                await localStorage.SetItemAsync("login_wait", DateTime.Now.AddMinutes(5));
                await ValidarIntentos();
            }

            else
            {

                await localStorage.SetItemAsync("login_tries", Intentos);
                toaster.ShowWarning("Por favor revisa tus credenciales.");
            }
        }

        finally
        {
            Cargando = false;
        }
    }
}
