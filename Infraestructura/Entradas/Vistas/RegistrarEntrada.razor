@layout AppLayout
@inject NavigationManager navegador
@inject HttpClient http  

@using Aplicacion.Entradas.Formularios
@page "/entrada/registrar"

<AuthorizeView Roles="logistica">
    <Authorized>
        <h3 class="title is-3">Registrar entrada</h3>

        <div class="form">
            <div class="field">
                <div class="control">
                    <button class="button is-primary" @onclick="AgregarElemento">+ Producto</button>
                </div>
            </div>

            <div class="field">
                @foreach (var detalle in detalles)
                {
                    <CartItem Detail="@detalle" Products="listaProductos" OnDelete="EliminarElemento" />
                }
            </div>

            <div class="field">
                <label class="label" for="observacion">Observación</label>
                <textarea id="observacion" class="textarea" type="text" @bind="entrada.Observacion"></textarea>
                <small>Opcional</small>
            </div>

            <div class="control is-grouped">
                @if (cargando)
                {
                    <button class="button is-primary is-loading">Registrar</button>
                }
                else
                {
                    <button class="button is-primary" @onclick="Enviar" disabled="@deshabilitar">Registrar</button>
                }
                <a href="/entrada" class="button is-outlined">Cancelar</a>
            </div>

        </div>
    </Authorized>
    <NotAuthorized>
        <p>No tienes permisos para esta vista</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    Entrada entrada { get; set; } = new Entrada();

    bool cargando = false;

    List<DetalleEntrada> detalles = new List<DetalleEntrada>();

    Producto[] listaProductos = new Producto[0];

    bool deshabilitar
    {
        get
        {
            return listaProductos.Length == 0;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaProductos = await http.GetFromJsonAsync<Producto[]>("/api/producto");
        }

        catch
        {
            listaProductos = new Producto[0];
        }
    }

    private void AgregarElemento()
    {
        detalles.Add(new DetalleEntrada());
    }

    private void EliminarElemento(IDetalle detalle)
    {
        detalles.Remove((DetalleEntrada) detalle);
    }

    async Task Enviar()
    {
        try
        {
            cargando = true;
            var formulario = new FormularioRegistrarEntrada()
            {
                Entrada = entrada,
                Detalles = detalles
            };

            var respuesta = await http.PostAsJsonAsync("/api/entrada", formulario);

            if (respuesta.IsSuccessStatusCode)
            {
                navegador.NavigateTo("/entrada");
            }
            cargando = false;
        }

        catch
        {
            throw; // TODO
        }
    }
}