@using System.Security.Claims
@using static System.Globalization.CultureInfo
@using Aplicacion.Pedidos.Formularios

@inject HttpClient http
@inject NavigationManager navegador
@inject AuthenticationStateProvider autentificacion

@page "/pedido/registrar"
@layout AppLayout

<h3>Registrar Pedido</h3>
<div class="form">
    <div class="field">
        <div class="control">
            <button class="button is-primary" @onclick="AgregarElemento">+ Producto</button>
        </div>
    </div>

    <div class="field">
        <div class="columns is-multiline">
            @foreach (var detalle in detalles)
            {
                <div class="column">
                    <ItemDetail listadoProductos="listaProductos" detalle="detalle" OnDeleted="EliminarElemento" />
                </div>
            }
        </div>
    </div>
    <div class="field">
        <label>Cliente</label>
        <select class="input" @bind="pedido.Cliente" required>
            <option value="0" disabled>Seleccionar...</option>

            @foreach (Cliente cliente in cliente)
            {
                <option value="@cliente.Id">@(cliente.Nombre.ToCapitalize())</option>
            }
        </select>
    </div>
    <div class="field">
        <label for="fecha">Fecha</label>
        <input id="fecha" class="input" type="datetime-local" @bind="pedido.Fecha" @bind:format="@CultureInfo.CurrentCulture.DateTimeFormat.SortableDateTimePattern" step="1" required />
    </div>
    <div class="field">
        <label for="descuento">Descuento</label>
        <div class="control is-attached">
            <span class="button is-static">%</span>
            <input id="descuento" type="number" placeholder="###" minlength="1" class="input" @bind="pedido.Descuento" required />
        </div>
        <div class="field">
            <label class="label">Estado</label>
            <select class="input" @bind="pedido.Estado" required>
                <option value="0" disabled>Seleccionar...</option>
                @foreach (Estado estado in estados)
                {
                    <option value="@estado">@estado</option>
                }
            </select>
        </div>
    </div>
</div>


<div class="field">
    <div class="control is-grouped">
        <button class="button is-primary" @onclick="Enviar">Registrar</button>
        <a href="/pedido" class="button is-outlined">Cancelar</a>
    </div>
</div>
@code {
    Array estados = Enum.GetValues(typeof(Estado));
    Cliente[] cliente { get; set; } = new Cliente[0];
    Usuario[] usuarios { get; set; } = new Usuario[0];
    Producto[] listaProductos { get; set; }

    protected override async Task OnInitializedAsync()
    {
        usuarios = await http.GetFromJsonAsync<Usuario[]>("/api/usuario");
        cliente = await http.GetFromJsonAsync<Cliente[]>("/api/cliente");
        try
        {
            listaProductos = await http.GetFromJsonAsync<Producto[]>("/api/producto");

        }
        catch
        {
            listaProductos = new Producto[0];
        }

    }

    private void AgregarElemento()
    {
        detalles.Add(new DetallePedido());
    }

    private void EliminarElemento(IDetalle detalle)
    {
        detalles.Remove((DetallePedido)detalle);
    }

    List<DetallePedido> detalles = new List<DetallePedido>();

    Pedido pedido { get; set; } = new Pedido();
    bool cargando = false;

    async Task Enviar()
    {
        cargando = true;

        try
        {
            var estado = await autentificacion.GetAuthenticationStateAsync();
            var serial = estado.User.FindFirst(ClaimTypes.SerialNumber);
            var formulario = new FormularioRegistrarPedido()
            {
                Pedido = pedido,
                Detalles = detalles
            };
            if (serial is null)
            {
                // TODO
            }

            else
            {
                int id = int.Parse(serial.Value);
                pedido.Asesor = id;

                var respuesta = await http.PostAsJsonAsync("/api/pedido", formulario);

                if (respuesta.IsSuccessStatusCode)
                {
                    navegador.NavigateTo("/pedido");
                }
            }
        }

        catch
        {
            // TODO
        }

        finally
        {
            cargando = false;
        }
    }
}